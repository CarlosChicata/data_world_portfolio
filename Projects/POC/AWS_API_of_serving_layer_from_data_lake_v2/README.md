# Case 5: API of serving layer stored from data lake in AWS V2

## Purpose and warning

I have a version 1 of serving layer based in data lake guided by data model( check the [case #1](https://github.com/CarlosChicata/data_world_portfolio/tree/master/Projects/POC/AWS_API_of_serving_layer_from_data_lake) to understand ); but i need to face some problems that version has (not all, i have a life üòõ), if i wanna improve it: 

1. Get a finer data access control according to policy for a user within an endpoint.
2. Delimit restriction of IAM roles in each used service.
3. Improve request response time performance.
4. Ability to update directly on the table with AWS Athena.

My acceptance criterias are:

* _Management of access in specified endpoints in API by users._ ‚¨ú
* _Improve security in infrastructure._ ‚¨ú
* _Improve performance in services layer._ ‚¨ú
* _Management of content in data model in data lake._ ‚¨ú

__If you want to expose the data of third users was generated by your useful or consumed common processes  for those third users with serverless architecture focus; i think this is a good option to explore__.

## Note about the problem context

‚ö†Ô∏è __Note:__ This section in same like case #1.


First, this is the data model to extract data. This is a data modeling based in normalization view of tables. The theme of the serving data layer is about logistic delivery of product. **Note**: don't focus in design of data model, i don't focus to be correct design to check if the model effects someway the POC case.

![Data model](https://github.com/CarlosChicata/data_world_portfolio/blob/master/Projects/POC/AWS_API_of_serving_layer_from_data_lake/code/image/POC%20serving%20layer%20-%20data%20model.png)

Second, this is the list of common queries will be consumed by our clients:

1. Get all detailed trackcode based in datetime range. I say `all_orders_by_range`.
2. Get all money generated by the routes and detailed in range of datetime. I say `get_money_from_routes_by_range`.
3. Get the most visited location from the trackcodes in range of datetime. I say `most_visited_location_from_trackcode_by_range`.
4. The number of trackcode generated based date in range of datetime. I say `count_trackcode_by_range`.
5. The number of orders by code generated during a date range. I say `count_orders_by_range`.
6. The number of trackcodes lost. I say `count_trackcode_lost_by_range`.
7. The most required service using during a date range. I say `most_required_service_by_range`.
8. Check how many orders are success delivery before the promise time in date range. I say `count_delivered_trackcode_before_promise_time_by_range`.


## Challenges

These are the main challenges to face:

1. _Make a custom queries parameters in AWS Athena based in specified role._  ‚¨ú
2. _Create a transactional data lake for storage layer._  ‚¨ú
3. _Delimi IAM Role for following services: AWS Gateway, Lambda, Athena and others_. ‚¨ú
4. _Improve the performance of REST API service ._  ‚¨ú

## Solution

### General Idea
I think the solutions for each group of challenge can be following ideas:

1. Could use AWS DynamoDB instead AWS Athena in the custom authorization process to get response. This service is serverless and high performance; i think it will give me a best performance with demand based pricing.

2. Could use iceberg format in Athena to manage the tables in data lake. I can get CRUD operations in data lake and manage it  easily.

3. Review all needed roles for all used service in this project, and delimit those.

4. Extend the services of authentication to pass what fields will return to clients; and the REST API to modify the query to accept the need fields based in permissions of client.

5. Modify data modelling of authorization and authentication control client: extend roles permission of clients.

### Diagram of solution

### How to prepare this project?

### How to set up this project?

#### By video

Soon i will upload the videos in spanish and english.

#### By step-by-step Documentation 

### How destroy the POC project? (By step-by-step Documentation )

### Topic issues

I needed to learn in my few free time some topics about AWS resources like Athena, Lambda, Glue, Cloudformation and API Gatewy; so i built based on simplicity and functional vision such that i got a POC in version 1 with minimum functionality to the main goal: __*delivery data on demand into my users.*__

#### Scalability: :star2::star2::star2::star2::star2:

:thumbsup: Because the architecture is serverless focus in general; the resources can created based in demand required in all kind of enviroment to solve all user requests. Any change in data or code can be apply in scale in this infrastructure model.


#### Performance: :star2::star2::star::star::star:

:thumbsup: Because the architecture is serverless focus in general; the HTTP API can responde in high request on 24/7. The auth lambda can cache the same authentication operation for same user.

:eyes: The auth lambda have a delay based in the performance of aws athena to get the data of access control table. I can understand the performance in SQL endpoint is accepted for now; but in high performance the time (average 10ms) can be a problem; so i need to optimize; in priority order; following issues: 

1. The data to use in AWS Athena (depend of use case)
2. The auth lambda response.
 
Based in AWS Athena behavier, i can do several same SQL operation with same params and don't use the previous generated data file.

Don't work for high amount of data need to return into the user because the transmission of data from API; and ; other point; depending of your format data in data can be update one easier.


#### Reusability: :star2::star2::star2::star::star:

:thumbsup: The great point is the IaC template to implement easily all resource AWS in the POC, so then i need to do minimum steps to implement total infrastructure of project. 

:eyes: One of the great problem in this POC is the duplicate of code in auth lambdas and sql endpoints: I consider the duplicate code in several auth lambdas and process like a chance to improve the structure of code and data model such that:

* In one query, i can get as amount as i can.
* Don't maintain several file with exactly like content for same goal.
* Get minimum and necessary logical processes in project.

#### Security :star2::star2::star::star::star:

:thumbsup: There are an authentication and authorization control the can be easy to use and apply inside the organization for the HTTP API.

:eyes: The IAM Roles need to be more restricted: anyone can be anything with these roles!. And all internal request in POC is running over internet, it expose to be hacked!.
